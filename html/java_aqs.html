<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>java_aqs - Henson's Blog</title>
		<link rel="stylesheet" href="../static/common.css">
		<link rel="stylesheet" href="../static/highlight/tomorrow.min.css">
		<script src="../static/highlight/highlight.min.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
		<style type="text/css">
		</style>
	</head>
	<body>
		<div class="main">
		<h1 id="javaabstractqueuedsynchronizer">Java AbstractQueuedSynchronizeræºä»£ç åˆ†æ</h1>
<p><code>AbstractQueuedSynchronizer</code>ï¼ˆä»¥ä¸‹ç®€ç§°ä¸ºaqsï¼‰æ˜¯Javaä¸­å„ç§é”(<code>Lock</code>)ã€ä¿¡å·é‡(<code>Semaphore</code>)ã€äº’æ–¥é‡(<code>Mutex</code>)ã€æ …æ (<code>Barrier</code>)ç­‰å®ç°çš„åŸºç¡€æ¡†æ¶ã€‚è¯¥æ¡†æ¶æ˜¯åŸºäºå˜ç§çš„<code>CLHé”</code>--ä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ä½œä¸ºåŸºç¡€æ•°æ®ç»“æ„çš„ã€‚CLHé”å…·æœ‰è¾ƒå¥½çš„æ€§èƒ½å’Œæ‰©å±•æ€§ã€‚</p>
<p>aqså°†èµ„æºçš„çŠ¶æ€æŠ½è±¡ä¸ºä¸€ä¸ªintå˜é‡ï¼Œé€šè¿‡åº•å±‚<code>CAS</code>åŸå­æ“ä½œæ¥æ”¹å˜å…¶çŠ¶æ€ï¼Œå…·ä½“æš´éœ²ç»™å­ç±»çš„çš„å‡½æ•°æœ‰ï¼š<code>getState</code>, <code>setState</code>, <code>compareAndSetState</code>ä¸‰ä¸ªã€‚åŒæ—¶ï¼Œå­ç±»åªéœ€è¦é€šè¿‡è¿™å‡ ä¸ªå‡½æ•°æ¥å®ç°è‡ªå·±çš„é€»è¾‘ï¼Œå…¶ä»–çš„åƒé˜Ÿåˆ—æ“ä½œã€çº¿ç¨‹é˜»å¡ç­‰ï¼Œaqså·²ç»å®ç°å¥½äº†ã€‚å…·ä½“éœ€è¦å®ç°çš„å‡½æ•°æœ‰<code>tryAcquire</code>, <code>tryRelease</code>, <code>tryAcquireShared</code>, <code>tryReleaseShared</code>, <code>isHeldExclusively</code>ã€‚</p>
<p>aqså°†èµ„æºçš„ç±»å‹åˆ†ä¸ºï¼šç‹¬å ï¼ˆexclusiveï¼‰å’Œå…±äº«ï¼ˆsharedï¼‰ä¸¤ç§æ¨¡å¼ã€‚å› æ­¤ï¼Œä»£ç ä¸­æ‰€æœ‰çš„æ“ä½œä¹Ÿæœ‰ä¸¤ç§å˜ä½“ã€‚é˜Ÿåˆ—çš„æ¯ä¸ªnodeä¹Ÿåˆ†ä¸ºä¸¤ç§ç±»å‹ã€‚å­ç±»éœ€è¦å®ç°çš„å‡½æ•°ä¹Ÿåˆ†æˆäº†ä¸¤ç±»ã€‚</p>
<p>å¦å¤–ï¼Œaqsä¹Ÿæ”¯æŒå¯¹ä¸€ä¸ªèµ„æºè®¾ç½®<code>æ¡ä»¶</code>é”ï¼šå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œæ‰è¿›å…¥æ­£å¸¸çš„é”ç«äº‰é˜¶æ®µã€‚</p>
<h3 id="clh">åº•å±‚æ•°æ®ç»“æ„-CLHé”çš„å˜ä½“</h3>
<p><center><img src="../imgs/aqs_data_structure.svg" alt="aqsæ•°æ®ç»“æ„å›¾" width="650" height="auto" /></center></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œaqsåº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œåˆ†åˆ«æœ‰<code>prev</code>å’Œ<code>next</code>ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘å‰åçš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ª<code>node</code>éƒ½æœ‰ï¼šä¸€ä¸ª<code>status</code>å­—æ®µç”¨æ¥æ ‡è®°è¯¥èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¸€ä¸ª<code>thread</code>å˜é‡ï¼Œè¡¨ç¤ºä»£è¡¨çš„çº¿ç¨‹ï¼Œè¿˜æœ‰ä¸€ä¸ª<code>nextWaiter</code>ï¼Œè¡¨ç¤ºæ¡ä»¶é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¿™ä¸ªåé¢ä¼šè®²ï¼‰ã€‚</p>
<p>å…¶ä¸­statuså¯ä»¥æ˜¯ä¸‹é¢çš„å‡ ç§ï¼š</p>
<ul>
<li><code>CANCELLED</code>ï¼šå€¼ä¸º1ï¼Œä»£è¡¨è¯¥threadç­‰å¾…è¶…æ—¶æˆ–è€…è¢«interruptäº†ï¼›</li>
<li><code>SIGNAL</code>ï¼šå€¼ä¸º-1ï¼Œè¡¨ç¤ºè¯¥threadéœ€è¦ç­‰å¾…è¢«å”¤é†’('signal me at proper time')ï¼Œåœ¨ç‹¬å æ¨¡å¼ä¸‹ï¼Œç­‰å¾…èŠ‚ç‚¹ä¸€èˆ¬æ˜¯è¿™ç§æƒ…å†µï¼›</li>
<li><code>CONDITION</code>ï¼šå€¼ä¸º-2ï¼Œè¡¨ç¤ºè¯¥threadæ˜¯ä¸ªæ¡ä»¶ç­‰å¾…èŠ‚ç‚¹ï¼Œéœ€è¦æ¡ä»¶è¾¾åˆ°ï¼Œæ‰èƒ½è¿›å…¥æ­£å¸¸çš„ç«äº‰é˜Ÿåˆ—ï¼›</li>
<li><code>PROPAGATE</code>ï¼šå€¼ä¸º-3ï¼Œå…±äº«æ¨¡å¼ä¸‹çš„ä¸€ç§æƒ…å†µï¼Œåé¢ä¼šä»‹ç»ï¼›</li>
<li>å…¶ä»–ï¼šåˆå§‹åŒ–ä¸º0ï¼Œåˆšæ–°å»ºçš„èŠ‚ç‚¹ã€‚</li>
</ul>
<h3 id="11">1.1 ç‹¬å æ¨¡å¼çš„è·å–èµ„æº</h3>
<pre><code class="java language-java">public final void acquire(int arg) { // ç‹¬å æ¨¡å¼è·å–èµ„æºï¼Œå¿½ç•¥ä¸­æ–­ï¼Œè°ƒç”¨tryAcquireè‡³å°‘ä¸€æ¬¡
    if (!tryAcquire(arg) &amp;&amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
</code></pre>
<p>è¿™æ˜¯ç‹¬å æ¨¡å¼çš„è·å–é”çš„ä¸»è¦å‡½æ•°ã€‚è¯¥å‡½æ•°å¿½ç•¥çº¿ç¨‹çš„interruptä¿¡å·ã€‚ä¼ å…¥çš„å‚æ•°å¯ä»¥å¿½ç•¥ï¼Œåªæœ‰åœ¨å¾ˆå°‘æƒ…å†µä¸‹æ‰ä¼šç”¨åˆ°ï¼Œè¿™é‡Œåªæ˜¯ç›´æ¥ä¼ ç»™å­å‡½æ•°çš„ã€‚<code>tryAcquire</code>åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å·²ç»è¯´è¿‡ï¼Œæ˜¯å­ç±»éœ€è¦å®ç°çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ ¹æ®åœºæ™¯ä¸åŒè€Œå¼‚ã€‚å¦‚æœè¯¥å‡½æ•°è¿”å›trueï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–èµ„æºæˆåŠŸäº†ï¼Œé‚£å°±ä¸éœ€è¦ä¸‹é¢çš„æ­¥éª¤äº†ï¼Œç›´æ¥è¿”å›ã€‚å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œè¯´æ˜éœ€è¦å…¥é˜Ÿç­‰å¾…ï¼Œä¹Ÿå°±æ˜¯<code>addWaiter</code>å‡½æ•°æ‰€åšçš„äº‹æƒ…ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<pre><code class="java language-java">private Node addWaiter(Node mode) {
    Node node = new Node(Thread.currentThread(), mode);
    Node pred = tail;
    if (pred != null) { // å¦‚æœä¹‹å‰æœ‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¿«é€Ÿé€šé“
        node.prev = pred;
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    enq(node); // å¸¸è§„æ¨¡å¼
    return node;
}
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) { // å¿…é¡»åˆå§‹åŒ–
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
</code></pre>
<p>å…ˆnewä¸€ä¸ªç‹¬å ç±»å‹çš„nodeï¼Œç„¶åæ’å…¥é˜Ÿåˆ—ä¸­ï¼šå…ˆæµ‹è¯•å¿«é€Ÿæ¨¡å¼ï¼Œç„¶åç”¨ä¸€èˆ¬çš„<code>enq</code>è¿›è¡Œæ’å…¥ã€‚</p>
<p>enqå‡½æ•°é‡‡ç”¨ç±»ä¼¼<code>è‡ªæ—‹</code>çš„æ–¹å¼å®ç°ï¼šå…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ä¸ªç©ºé˜Ÿåˆ—ï¼ˆnull==tailï¼‰ï¼Œç„¶åæŒ‰ç…§ä¸€èˆ¬æ¨¡å¼æ’å…¥ï¼Œå½“ç„¶éƒ½è¦é‡‡ç”¨åŸå­çš„æ–¹å¼ï¼ˆCASï¼‰è¿›è¡Œã€‚ä»è¿™é‡Œçš„ä»£ç ï¼Œå¯ä»¥å‘ç°ï¼Œ<span style="text-decoration:underline;"><strong><em>headèŠ‚ç‚¹å…¶å®æ˜¯ä¸ªdummyèŠ‚ç‚¹</em></strong></span>ã€‚</p>
<p><span style="text-decoration:underline;"><strong><em>è™½ç„¶æ’å…¥é˜Ÿåˆ—äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½®è¯¥èŠ‚ç‚¹çš„waitStatusï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¸€èµ·è®¾ç½®äº†å‘¢ï¼Ÿ</em></strong></span></p>
<p>è¿™æ˜¯ç”±äºï¼šé˜Ÿåˆ—ä¸­å¯èƒ½å·²ç»å­˜åœ¨å¾ˆå¤šç­‰å¾…èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ç­‰å¾…ç±»å‹ä¸åŒï¼šæœ‰å¯èƒ½æ˜¯å·²ç»cancelçš„ã€æœ‰æ¡ä»¶ç­‰å¾…åˆšè¢«transferè¿›æ¥çš„ï¼ˆåé¢ä¼šè®²ï¼‰ã€è¿˜æœ‰åˆšåˆšåˆå§‹åŒ–ï¼ˆæˆ‘ä»¬è¿™ç§æƒ…å†µï¼‰æ’å…¥çš„ï¼Œè¿˜æœ‰å·²ç»è®¾ç½®ä¸º<code>signal</code>ï¼ˆç­‰å¾…è¢«å”¤é†’ï¼‰çš„ã€‚æˆ‘ä»¬èŠ‚ç‚¹æ˜¯åº”è¯¥è¦æ’å…¥signalèŠ‚ç‚¹çš„åé¢ï¼Œå¦‚æœæ²¡æœ‰è¿™ç§èŠ‚ç‚¹ï¼Œåˆ™å°†headèŠ‚ç‚¹è®¾ç½®æˆè¿™ä¸ªèŠ‚ç‚¹ï¼Œå¹¶è®¾ç½®æˆsignalã€‚</p>
<p>ä¸‹é¢çœ‹ä¸€ä¸‹å…·ä½“ä»£ç ï¼š</p>
<pre><code class="java language-java">final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();  // æ¯æ¬¡éƒ½è¦é‡æ–°è·å–æ–°çš„å‰ç½®èŠ‚ç‚¹
            if (p == head &amp;&amp; tryAcquire(arg)) { // æ¯æ¬¡éƒ½éœ€è¦é‡æ–°æ£€æŸ¥æ˜¯å¦å¯ä»¥è·å–èµ„æºäº†
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;   // åªæœ‰åœ¨è¿™é‡Œæ‰èƒ½é€€å‡ºè¯¥å‡½æ•°
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())  // è¿™é‡Œblockè¯¥çº¿ç¨‹çš„æ‰§è¡Œï¼Œå¹¶æ£€æŸ¥æ˜¯å¦è¢«interruptè¿‡
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);  // å¼‚å¸¸æƒ…å†µä¼šåˆ°è¿™
    }
}
</code></pre>
<p>ä¹Ÿæ˜¯é‡‡ç”¨ç±»ä¼¼è‡ªæ—‹çš„æ–¹å¼å®ç°ã€‚æ¯æ¬¡<em>é‡æ–°è·å–å‰ç½®èŠ‚ç‚¹</em>å’Œ<em>æ£€æŸ¥æ˜¯å¦èƒ½è·å–èµ„æº</em>çš„åŸå› æ˜¯ï¼šåœ¨å¤šä¸ªçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´çš„æŒ‡ä»¤é‡æ’æˆ–è€…å…¶ä»–çº¿ç¨‹å¯èƒ½é‡Šæ”¾èµ„æºï¼Œå‰ä¸€è½®å¾ªç¯çš„ç¯å¢ƒçŠ¶æ€å·²ç»å‘ç”Ÿå˜åŒ–äº†ï¼Œæ‰€ä»¥åœ¨<code>park</code>çº¿ç¨‹å‰éœ€è¦é‡æ–°æ£€æŸ¥ï¼Œå°½é‡é¿å…ä¸å¿…è¦çš„parkå’Œunparkã€‚</p>
<p>è¯¥å‡½æ•°ç»“æŸæœ‰ä¸¤ç§æƒ…å†µï¼š1. å½“å‰çº¿ç¨‹å¾—åˆ°äº†ç«äº‰çš„èµ„æº(p == head &amp;&amp; tryAcquire(arg))ï¼›2. æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šä¼ é€’åˆ°ä¸Šå±‚çš„ä»£ç ä¸­ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹<code>shouldParkAfterFailedAcquire</code>å‡½æ•°ï¼Œå¯ä»¥å½¢è±¡çš„å«åš<code>æ‰¾è½¦ä½</code>å‡½æ•°ï¼š</p>
<pre><code class="java language-java">private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
    int ws = pred.waitStatus;
    if (ws == Node.SIGNAL) // ä¹‹å‰å·²ç»æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿç­‰äº†ï¼Œé‚£æˆ‘ä»¬ä¹Ÿåªèƒ½ç­‰äº†
        return true;
    if (ws &gt; 0) {
        do {    // å‰ç½®èŠ‚ç‚¹æ˜¯ä¸ªcancelèŠ‚ç‚¹ï¼Œé‚£å°±éœ€è¦å¯»æ‰¾écancelçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
            node.prev = pred = pred.prev;  //
        } while (pred.waitStatus &gt; 0);
        pred.next = node;
    } else {
         // waitStatusè‚¯å®šæ˜¯0æˆ–è€…propagateï¼Œå…ˆæš‚æ—¶ä¸è¦è¿”å›trueæ¥blockè¯¥çº¿ç¨‹ï¼Œ
         // ä¸‹ä¸€æ¬¡å¾ªç¯ä¼šå†æ¬¡è¯•å›¾è·å–ï¼ˆtryAcquireï¼‰ï¼Œå¤–å¾ªç¯â€œè‡ªæ—‹â€
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);// åªæ˜¯æ ‡è®°ä¸€ä¸‹predä¸ºsignalï¼Œæ— æ‰€è°“æˆåŠŸä¸å¦ï¼Œå› ä¸ºå¤–é¢æœ‰ä¸ªâ€œè‡ªæ—‹â€
    }
    return false;
}
</code></pre>
<p>è¯¥å‡½æ•°å…¶å®æ˜¯ç»™nodeå‡ ç‚¹å¯»æ‰¾çœŸæ­£è¦'park'çš„ä½ç½®ã€‚æ€»ä½“é€»è¾‘å°±æ˜¯å¯»æ‰¾å¯ä»¥'park'çš„èŠ‚ç‚¹ï¼Œç„¶åæŠŠå½“å‰èŠ‚ç‚¹æ”¾åœ¨å®ƒåé¢ã€‚æ‰€è°“å¯ä»¥parkï¼Œå°±æ˜¯è¯¥èŠ‚ç‚¹æ˜¯ä¸ªâ€œç­‰å¾…è¢«å”¤é†’â€çš„èŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„å‰ç½®èŠ‚ç‚¹ï¼Œå³èŠ‚ç‚¹çš„statuså¯èƒ½æ˜¯0æˆ–è€…'PROPAGATE'ï¼Œè¿™ç§æƒ…å†µï¼Œè®¾ç½®ä¸ºsignalèŠ‚ç‚¹ï¼Œç­‰å¾…ä¸‹ä¸€è½®æ“ä½œï¼ˆåœ¨ä¸€ä¸ªè‡ªæ—‹ä»£ç å—ä¸­ï¼‰ã€‚</p>
<p>å¦‚æœç¡®å®éœ€è¦'park'ï¼Œåˆ™è¿›å…¥<code>parkAndCheckInterrupt</code>å‡½æ•°ï¼š</p>
<pre><code class="java language-java">private final boolean parkAndCheckInterrupt() {
    LockSupport.park(this);
    return Thread.interrupted();
}
</code></pre>
<p>è¿™é‡Œï¼Œåˆ©ç”¨<code>LockSupport</code>æä¾›çš„<code>park</code>å’Œ<code>unpark</code>æ¥suspendå’Œresumeä¸€ä¸ªçº¿ç¨‹ï¼Œä»£æ›¿<code>Thread.suspend</code>å’Œ<code>Thread.resume</code>ï¼Œå› ä¸ºåè€…ä¼šäº§ç”Ÿæ­»é”ï¼Œå·²ç»è¢«JDK1.7ä¸­æ ‡è®°ä¸ºdeprecatedäº†ã€‚</p>
<h4 id="">æµç¨‹å›¾</h4>
<p><center><img src="../imgs/aqs_acquire.svg" alt="aqs acquireæµç¨‹å›¾" width="750" height="auto" /></center></p>
<ul>
<li>1. è°ƒç”¨tryAcquireè¯•å›¾è·å–èµ„æºï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¿”å›ï¼›å¦åˆ™è¿›å…¥ç¬¬2æ­¥ï¼›</li>
<li>2. å¯èƒ½éœ€è¦æ’é˜Ÿã€‚å…ˆnewä¸€ä¸ªexcludeæ¨¡å¼çš„nodeï¼Œå¹¶addWaiteræ’å…¥é˜Ÿåˆ—ä¸­ï¼Œè¿›å…¥è‡ªæ—‹ä»£ç å—ï¼›</li>
<li>3.1 <span style="text-decoration:underline;"><em>æ£€æŸ¥predæ˜¯å¦æ˜¯headï¼Œå¹¶å†è¯•ä¸€æ¬¡tryAcquireã€‚å¦‚æœéƒ½æˆåŠŸï¼ŒsetHeadè¿”å›ï¼›å¦åˆ™ä¸‹ä¸€æ­¥ï¼›</em></span></li>
<li>3.2 <span style="text-decoration:underline;"><em>æŸ¥çœ‹æ˜¯å¦éœ€è¦ç«‹å³parkï¼Œå¦‚æœæ˜¯ï¼Œåˆ™blockå½“å‰çº¿ç¨‹å¹¶æ£€æŸ¥ä¸­æ–­æ ‡è®°ï¼›å¦åˆ™è‡ªæ—‹ï¼Œè¿›å…¥3.1ï¼›</em></span></li>
<li>3.3 <span style="text-decoration:underline;"><em>å½“å…¶ä»–çº¿ç¨‹å”¤é†’è¯¥çº¿ç¨‹æ—¶ï¼ˆunpaarkSuccessorï¼‰ï¼Œä»blockedçŠ¶æ€æ¢å¤æ‰§è¡Œï¼Œè¿›å…¥3.1ï¼›</em></span></li>
<li>4. åœ¨ç¬¬ä¸‰æ­¥ä¸­å¦‚æœæœ‰å¼‚å¸¸ï¼Œåˆ™cancelï¼Œè®¾ç½®CANCELLEDã€‚</li>
</ul>
<h4 id="-1">å‡ ç‚¹è¯´æ˜</h4>
<ul>
<li>1. headèŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼ˆå¦‚æœä¸ä¸ºnullï¼‰æŒæœ‰ç«äº‰çš„èµ„æºï¼›</li>
<li>2. åœ¨parkè¿™æ­¥ä¸­ï¼Œæ¯æ¬¡æ›´æ–°äº†èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä¸ºäº†å‡å°‘ä¸å¿…è¦çš„æ“ä½œï¼ˆparkå’Œunparkï¼‰éƒ½ä¼šå°è¯•å†æ¬¡è·å–èµ„æºï¼Œå¦‚æœæˆåŠŸå°±ä¸ä¼šblockï¼›</li>
<li>3. æ–°åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¹¶æ²¡æœ‰è®¾ç½®å…¶waitStatusï¼ˆä¸º0ï¼‰ï¼Œåªæœ‰åœ¨å…¶åé¢å†æ’å…¥å…¶ä»–èŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šè®¾ç½®ä¸ºsignalï¼›</li>
<li>4. åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®°å½•interruptçŠ¶æ€ï¼Œåœ¨è·å–èµ„æºæˆåŠŸåï¼Œéœ€è¦é‡æ–°interruptè¯¥çº¿ç¨‹ï¼›</li>
</ul>
<h3 id="12">1.2 ç‹¬å æ¨¡å¼çš„é‡Šæ”¾èµ„æº</h3>
<p>åœ¨ä¸Šé¢çš„è·å–èµ„æºçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼šå¦‚æœä¸€ä¸ªèµ„æºç«äº‰å¾—åˆ°èµ„æºäº†ï¼Œå®ƒä¼šè¢«è®¾ç½®åˆ°å¤´èŠ‚ç‚¹ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬é‡Šæ”¾æ—¶ï¼Œç›´æ¥ä»headå¼€å§‹æ£€æŸ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java language-java">public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
</code></pre>
<p>é¦–å…ˆï¼Œè°ƒç”¨å­ç±»çš„<code>tryRelease</code>åšç›¸å…³çš„é‡Šæ”¾èµ„æºçš„å·¥ä½œï¼Œç„¶åä»headå¼€å§‹ï¼ˆå½“å‰çš„çº¿ç¨‹æ‰€åœ¨çš„nodeï¼‰ï¼Œå¯»æ‰¾éœ€è¦è¢«å”¤é†’çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœheadçš„waitStatusä¸º0ï¼Œåˆ™æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œä¸éœ€è¦å¯»æ‰¾äº†ï¼Œç›´æ¥é€€å‡ºã€‚å¦‚æœä¸ä¸º0ï¼Œåˆ™å¯èƒ½å­˜åœ¨éœ€è¦å”¤é†’çš„å…¶ä»–èŠ‚ç‚¹ã€‚</p>
<pre><code class="java language-java">private void unparkSuccessor(Node node) {
    int ws = node.waitStatus;
    if (ws &lt; 0) // å¦‚æœstatuså°äº0ï¼Œè®¾ç½®ä¸º0ï¼Œè®©å…¶ä¸è¦å†å‚ä¸äº†
        compareAndSetWaitStatus(node, ws, 0); // ç‹¬å æ¨¡å¼æ— æ‰€è°“å¤±è´¥ï¼ˆå…±äº«æ¨¡å¼ä¼šåœ¨è°ƒç”¨è¯¥å‡½æ•°ä¹‹å‰ç¡®ä¿è®¾ç½®æˆåŠŸï¼‰
    Node s = node.next;  // ä¸€èˆ¬ä¸‹ä¸€ä¸ªå°±æ˜¯éœ€è¦çš„å”¤é†’çš„èŠ‚ç‚¹ï¼Œè¿™æ˜¯nextå­—æ®µå­˜åœ¨çš„æœ€å¤§æ„ä¹‰
    if (s == null || s.waitStatus &gt; 0) {
        s = null;
        for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev)  // å¯»æ‰¾ç¬¬ä¸€ä¸ªécancelçš„èŠ‚ç‚¹
            if (t.waitStatus &lt;= 0)
                s = t;  // æ³¨æ„ï¼Œè¿™é‡Œæ²¡æœ‰breakï¼Œä¹‹å‰è€ä»¥ä¸ºæ˜¯æœ€åä¸€ä¸ªğŸ˜…
    }
    if (s != null)
        LockSupport.unpark(s.thread);
}
</code></pre>
<p>åŸºæœ¬é€»è¾‘ï¼Œæ˜¯å¯»æ‰¾ä¸‹ä¸€ä¸ªè¦å”¤é†’çš„èŠ‚ç‚¹ï¼›å¤§éƒ¨åˆ†æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨nextå°±å¯ä»¥æ‹¿åˆ°ã€‚å°‘éƒ¨åˆ†æƒ…å†µï¼Œéœ€è¦ä»é˜Ÿå°¾å‘å‰æ‰¾ã€‚</p>
<p>unparkä¹‹åï¼Œå½“å‰çº¿ç¨‹æ¢å¤æ‰§è¡Œï¼Œä»ä¹‹å‰çš„blockç‚¹ï¼šåœ¨<code>acquireQueued</code>çš„è‡ªæ—‹å¾ªç¯é‡Œï¼Œå¼€å§‹ã€‚ç„¶åï¼šå¦‚æœæ˜¯é€šè¿‡nextæ‰¾åˆ°çš„ï¼Œåˆ™ç¬¬ä¸€ä¸ªif(p == head &amp;&amp; tryAcquire(arg))ä¸­<code>p == head</code>æ˜¯æˆç«‹çš„ï¼Œåé¢å†æ¬¡è¯•å›¾è·å–èµ„æºï¼›å¦‚æœæ˜¯åé¢çš„æŸä¸ªèŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡åé¢çš„<code>shouldParkAfterFailedAcquire</code>ç»§ç»­ã€‚</p>
<h3 id="13acquire">1.3 ç‹¬å ç±»å‹acquireçš„å…¶ä»–å˜ä½“</h3>
<ul>
<li><p>1. <code>acquireInterruptibly</code>å‡½æ•°</p>
<p>ä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ˜¯å¯ä»¥interruptçš„acquireå‡½æ•°ã€‚å’Œacquireä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œå¦‚æœåœ¨æ•´ä¸ªè·å–èµ„æºçš„è¿‡ç¨‹ä¸­ï¼šacquireå‡½æ•°ä¼šè®°å½•çº¿ç¨‹æ˜¯å¦è¢«interruptè¿‡ï¼Œç„¶ååœ¨è·å–æˆåŠŸåï¼Œé‡æ–°è§¦å‘ä¸€æ¬¡interruptï¼›è€Œè¯¥å‡½æ•°åˆ™åœ¨æœ‰interruptçš„æ—¶å€™ï¼Œç›´æ¥throw<code>InterruptedException</code>å‡ºæ¥ã€‚æ‰€ä»¥ï¼Œæ‰§è¡Œacquireå‡½æ•°çš„çº¿ç¨‹åœ¨è·å–èµ„æºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¿½ç•¥interruptä¿¡å·ï¼Œç›´åˆ°è·å–æˆåŠŸåï¼Œå†æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰è¿‡interruptï¼Œå¦‚æœæœ‰ï¼Œåˆ™<code>selfInterrupt</code>ã€‚è€Œè¯¥å‡½æ•°åˆ™ä¼šç›´æ¥æŠ›å‡ºã€‚</p>
<p>ä»£ç ç‰‡æ®µï¼š</p>
<pre><code class="java language-java">// ä¸»å‡½æ•°ä¸­ä¸åŒçš„åœ°æ–¹
if (Thread.interrupted())
    throw new InterruptedException();
// doAcquireInterruptiblyä¸­å’ŒacquireQueuedä¸åŒçš„åœ°æ–¹
if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())
    throw new InterruptedException();
</code></pre></li>
<li><p>2. <code>tryAcquireNanos</code>å‡½æ•°</p>
<p>è¯¥å‡½æ•°æ˜¯acquireçš„è¶…æ—¶ç‰ˆæœ¬ï¼ŒåŒæ—¶å’ŒacquireInterruptiblyä¸€æ ·ï¼Œä¼šåœ¨æ”¶åˆ°interruptä¿¡å·æ—¶ï¼Œç›´æ¥throwå¼‚å¸¸å‡ºæ¥ã€‚</p>
<p>ä»£ç ç‰‡æ®µï¼š</p>
<pre><code class="java language-java">// å’ŒacquireQueuedä¸»è¦ä¸åŒçš„åœ°æ–¹ï¼ŒnanosTimeoutæ—¶æ¯æ¬¡è‡ªæ—‹çš„æ—¶å€™ï¼Œè®¡ç®—çš„å‰©ä½™æ—¶é—´
// spinForTimeoutThresholdåˆ™æ˜¯ä¸ºäº†ä¼˜åŒ–è®¾ç½®çš„ä¸€ä¸ªé˜ˆå€¼ï¼Œå°äºé˜ˆå€¼æ—¶ï¼Œç›´æ¥è‡ªæ—‹ä¸‹æ¬¡
if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; nanosTimeout &gt; spinForTimeoutThreshold)
    LockSupport.parkNanos(this, nanosTimeout);
</code></pre></li>
</ul>
<h3 id="14cancelacquire">1.4 cancelAcquireå‡½æ•°</h3>
<pre><code class="java language-java">private void cancelAcquire(Node node) {
    if (node == null) // Ignore if node doesn't exist
        return;
    node.thread = null;
    // Skip cancelled predecessors
    Node pred = node.prev;
    while (pred.waitStatus &gt; 0) //å¯»æ‰¾åˆæ³•çš„å‰ç¼€èŠ‚ç‚¹
        node.prev = pred = pred.prev;
    Node predNext = pred.next;
    node.waitStatus = Node.CANCELLED;  // æ ‡è®°ä¸ºcancelled
    // If we are the tail, remove ourselves.
    if (node == tail &amp;&amp; compareAndSetTail(node, pred)) { // å¦‚æœæ˜¯tailç›´æ¥åˆ é™¤
        compareAndSetNext(pred, predNext, null);
    } else {
        // If successor needs signal, try to set pred's next-link
        // so it will get one. Otherwise wake it up to propagate.
        int ws;
        if (pred != head &amp;&amp;
            ((ws = pred.waitStatus) == Node.SIGNAL ||
             (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;
            pred.thread != null) {
            Node next = node.next;
            if (next != null &amp;&amp; next.waitStatus &lt;= 0) // å°†nextèŠ‚ç‚¹é“¾æ¥åˆ°predçš„nextä¸Šï¼Œé“¾è¡¨çš„åˆ é™¤æ“ä½œ
                compareAndSetNext(pred, predNext, next);
        } else { // å‰ç¼€æ˜¯headèŠ‚ç‚¹ï¼Œåˆ™è¦å”¤é†’åé¢çš„èŠ‚ç‚¹
            unparkSuccessor(node);
        }
        node.next = node; // help GC
    }
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨acquireå¼‚å¸¸çš„æ—¶å€™è§¦å‘ï¼Œå¼‚å¸¸åˆ™æ¥è‡ªäºå‰é¢çš„ä¸¤ä¸ªå‡½æ•°acquireInterruptiblyå’ŒtryAcquireNanosã€‚å®ç°é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼šå…ˆæ‰¾åˆ°åˆæ³•å‰ç¼€èŠ‚ç‚¹ï¼Œæ ‡è®°èŠ‚ç‚¹ä¸ºcancelledï¼Œç„¶åï¼šå¦‚æœnodeæ˜¯é˜Ÿå°¾ï¼Œç›´æ¥åˆ é™¤ï¼›å¦‚æœæ˜¯é˜Ÿåˆ—ä¸­ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼ˆpredæ˜¯headï¼‰ï¼Œåˆ™å”¤é†’åé¢çš„èŠ‚ç‚¹ï¼›å…¶ä»–æƒ…å†µï¼Œåˆ™æŠŠnodeçš„nextèŠ‚ç‚¹é“¾æ¥åˆ°predåé¢ï¼Œå…¶å®å°±æ˜¯åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚</p>
<h3 id="15release">1.5 releaseæ“ä½œ</h3>
<pre><code class="java language-java">public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
</code></pre>
<p>releaseæ“ä½œéå¸¸ç®€å•ï¼šå…ˆè°ƒç”¨å­ç±»çš„tryReleaseåšèµ„æºçŠ¶æ€ç­‰çš„ä¿®æ”¹ï¼Œç„¶åå”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…signalçš„çº¿ç¨‹ã€‚å› ä¸ºï¼ŒæŒæœ‰èµ„æºçš„çº¿ç¨‹æ˜¯headçš„nextèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä»headå¼€å§‹å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹å³å¯ã€‚</p>
<h3 id="16">1.6 ç‹¬å ç±»å‹æ€»ç»“</h3>
<p>ä»ä¸Šé¢çš„åˆ†æï¼Œå¯ä»¥çœ‹å‡ºnextæŒ‡é’ˆï¼Œç”¨æ¥å¿«é€Ÿçš„é€šçŸ¥ä¸‹ä¸€ä¸ªè¦å”¤é†’çš„èŠ‚ç‚¹ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸€ç§ä¼˜åŒ–æ‰‹æ®µï¼Œå¹¶ä¸ä¾èµ–ã€‚è‡³äºï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„waitStatusï¼Œæˆ‘ä»¬è¿™é‡Œåªæ¶‰åŠåˆ°äº†ä¸ºsignalå’Œ0çš„æƒ…å†µï¼Œå…¶ä»–å‡ ç§æƒ…å†µè¿˜æ²¡æœ‰ç¢°åˆ°ã€‚åˆ†ææºä»£ç çš„æ—¶å€™ï¼Œå°½é‡ä¸¤ä¸ªå‡½æ•°ä½œä¸ºä¸€å¯¹ï¼Œä¸€èµ·æ¥åˆ†æï¼Œæ‰èƒ½å¤Ÿæ›´å®¹æ˜“çš„ç†è§£ã€‚</p>
<h3 id="21acquire">2.1 å…±äº«ç±»å‹çš„acquireæ“ä½œ</h3>
<p>å’Œç‹¬å æ¨¡å¼ä¸€æ ·ï¼šå…ˆè°ƒç”¨å­ç±»çš„<code>tryAcquireShared</code>å‡½æ•°ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™å…¥é˜Ÿç­‰å¾…ã€‚è¯¥å‡½æ•°å¿½ç•¥interruptã€‚</p>
<p>tryAcquireSharedå‡½æ•°çš„è¿”å›å€¼ï¼š<br />
<code>&gt;0</code>: æˆåŠŸï¼Œè¿˜æœ‰å‰©ä½™èµ„æºï¼Œåç»­çº¿ç¨‹è¿˜å¯ä»¥ç»§ç»­è¯·æ±‚ï¼›<br />
<code>=0</code>: æˆåŠŸï¼Œæ²¡æœ‰å‰©ä½™èµ„æºï¼Œåç»­èµ„æºä¸èƒ½è¯·æ±‚ï¼›<br />
<code>&lt;0</code>: å¤±è´¥ï¼›  </p>
<pre><code class="java language-java">private void doAcquireShared(int arg) {
    final Node node = addWaiter(Node.SHARED);
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head) {
                int r = tryAcquireShared(arg);
                if (r &gt;= 0) {
                    setHeadAndPropagate(node, r);  // å’Œç‹¬å æ¨¡å¼ä¸åŒçš„åœ°æ–¹ï¼Œå¯ä»¥å¤šä¸ªèŠ‚ç‚¹è®¾ç½®head
                    p.next = null; // help GC
                    if (interrupted)
                        selfInterrupt();
                    failed = false;
                    return;
                }
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
</code></pre>
<p>å¯ä»¥çœ‹å‡ºå’Œç‹¬å æ¨¡å¼çš„é€»è¾‘åŸºæœ¬ç±»ä¼¼ï¼Œåªæœ‰åœ¨æˆåŠŸè·å–èµ„æºæ—¶çš„å¤„ç†ä¸åŒï¼Œå³å‡½æ•°<code>setHeadAndPropagate</code>ï¼š</p>
<pre><code class="java language-java"> private void setHeadAndPropagate(Node node, int propagate) {
    Node h = head; // Record old head for check below
    setHead(node);
    if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || // waitStatus &lt; 0ï¼Œè¡¨ç¤ºä¸Šæ¬¡æœ‰èŠ‚ç‚¹é‡Šæ”¾è¿‡èµ„æºï¼Œ
        (h = head) == null || h.waitStatus &lt; 0) {  // ä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ç­‰å¾…çš„èŠ‚ç‚¹ï¼ˆé€šè¿‡propagateæ ‡è®°è¿‡ï¼‰
        Node s = node.next;
        if (s == null || s.isShared())
            doReleaseShared();
    }
}
</code></pre>
<p>å…¶ä¸­ï¼ŒsetHeadå’Œç‹¬å æ¨¡å¼æ˜¯ä¸€æ ·çš„ï¼Œæ ‡è®°å½“å‰æ­£åœ¨å æœ‰èµ„æºçš„çº¿ç¨‹èŠ‚ç‚¹ã€‚ä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºè¿™ä¸ª<code>propagate</code>ã€‚</p>
<p><strong>propagateçš„æ„æ€æ˜¯</strong>ï¼šå½“å”¤é†’ä¸€ä¸ªpropagateèŠ‚ç‚¹æ—¶ï¼Œéœ€è¦ç»§ç»­å”¤é†’å…¶åç»­èŠ‚ç‚¹ï¼Œå°†è¿™ç§å”¤é†’çŠ¶æ€â€œä¼ æ’­â€ä¸‹å»ã€‚propagateåªä¼šè®¾ç½®åœ¨headèŠ‚ç‚¹ä¸Šï¼ˆå‚è§ä¸‹é¢çš„doReleaseSharedä»£ç ï¼‰ã€‚</p>
<h3 id="22release">2.2 å…±äº«æ¨¡å¼çš„releaseæ“ä½œ</h3>
<pre><code class="java language-java">private void doReleaseShared() {
    for (;;) {
        Node h = head;
        if (h != null &amp;&amp; h != tail) {
            int ws = h.waitStatus;
            if (ws == Node.SIGNAL) {  // å”¤é†’åœ¨ç­‰å¾…signalçš„åç»­èŠ‚ç‚¹
                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))
                    continue;            // loop to recheck cases
                unparkSuccessor(h);
            }
            else if (ws == 0 &amp;&amp;
                     !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) // æ ‡è®°ä¸ºpropagateï¼Œå¹¶è·³è¿‡æœ¬è½®ï¼Œç­‰å¾…ä¸‹ä¸€è½®
                continue;                // loop on failed CAS
        }
        if (h == head)                   // loop if head changed
            break;
    }
}
</code></pre>
<p>ç±»ä¼¼ç‹¬å æ¨¡å¼ï¼Œ<code>releaseShared</code>å…ˆè°ƒç”¨å­ç±»çš„tryReleaseï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è°ƒç”¨ä¸Šé¢çš„å‡½æ•°ï¼Œæ¥æ“ä½œé˜Ÿåˆ—ã€‚</p>
<ul>
<li>1. å½“headçš„waitStatusæ˜¯<code>SIGNAL</code>æ—¶ï¼Œå’Œç‹¬å æ¨¡å¼ä¸€æ ·ï¼Œè¯´æ˜åç»­èŠ‚ç‚¹æ­£åœ¨ç­‰å¾…å”¤é†’ï¼Œé‚å”¤é†’ä¹‹ï¼›  </li>
<li>2. å½“headçš„waitStatusæ˜¯<code>0</code>æ—¶ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ï¼šç¬¬ä¸€æ¬¡è¯•å›¾tryAcquireæ—¶å¤±è´¥åï¼Œåˆå§‹åŒ–ä¸€ä¸ªnodeï¼Œå¹¶addWaiteråˆ°é˜Ÿå°¾ï¼›è¿›å…¥è‡ªæ—‹ï¼šç¬¬äºŒæ¬¡ï¼ˆæˆ–è€…ç¬¬ä¸‰æ¬¡ï¼‰æ£€æŸ¥tryAcquireæˆåŠŸï¼Œè¿™æ—¶å€™setHeadï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥èŠ‚ç‚¹å·²ç»è·å–èµ„æºäº†ï¼Œä¸éœ€è¦ç­‰å¾…signalï¼Œåœ¨releaseæ—¶åº”è¯¥æ ‡è®°ä¸€ä¸‹å¹¶è·³è¿‡æœ¬è½®å¾ªç¯ã€‚</li>
</ul>
<h3 id="23propagatewaitstatus">2.3 ä¸ºä»€ä¹ˆéœ€è¦PROPAGATEè¿™ä¸ªwaitStatus</h3>
<p>è¿™æ˜¯å› ä¸ºï¼šå”¤é†’ç­‰å¾…èŠ‚ç‚¹ï¼Œ<span style="text-decoration:underline;"><strong><em>åªä¼šå‘ç”Ÿåœ¨headèŠ‚ç‚¹çš„waitStatusä¸ºsignalæ—¶</em></strong></span>ï¼Œè¿™æ˜¯ç‹¬å å’Œå…±äº«æ¨¡å¼ç›¸åŒçš„åŸåˆ™ï¼›</p>
<p>ä½†æ˜¯ï¼Œç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ä¸åŒçš„åœ°æ–¹åœ¨äºï¼š<span style="text-decoration:underline;"><strong><em>å…±äº«æ¨¡å¼ï¼Œå¯ä»¥å¤šä¸ªèŠ‚ç‚¹åŒæ—¶è®¾ç½®head</em></strong></span>ï¼Œè¡¨ç¤ºè‡ªå·±å æœ‰èµ„æºã€‚è¿™æ ·ä¾¿ä¼šå‘ç”Ÿheadçš„waitStatusä¸º0çš„æƒ…å†µï¼Œç„¶ååœ¨releaseæ—¶ï¼Œå¯¹äºè¿™ç§æƒ…å†µçš„å¤„ç†æ–¹å¼å°±æ˜¯åšä¸€ä¸ªæ ‡è®°ï¼ˆpropagateï¼‰ï¼Œè¡¨ç¤º<em>æœ‰å…¶ä»–èŠ‚ç‚¹æ›¾ç»é‡Šæ”¾è¿‡èµ„æº</em>ï¼Œå¦‚æœä¸‹ä¸€æ¬¡è·å–èµ„æºæ—¶ï¼Œç¢°åˆ°è¿™ç§waitsStatusçš„headæ—¶ï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œreleaseï¼Œå”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…signalçš„èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ç­‰åˆ°ä¸‹ä¸€æ¬¡æ˜¾å¼çš„è°ƒç”¨releaseSharedã€‚</p>
<h3 id="31">3.1 å¯¹æ¡ä»¶çš„æ”¯æŒ</h3>
<p>aqsæä¾›äº†ä¸€ä¸ª<code>ConditionObject</code>çš„ç±»ï¼Œæ¥å®ç°<code>Lock</code>æ¥å£ï¼Œæä¾›ç±»ä¼¼Objectçš„waitå’Œnotifyçš„æ“ä½œï¼Œè¿›è€Œå®ç°åœ¨ä¸€ä¸ªé”ä¸Šçš„æ¡ä»¶ç­‰å¾…å’Œå”¤é†’ã€‚<br />
åœ¨å…¶å†…éƒ¨ï¼ŒaqsåŒæ ·ä½¿ç”¨äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå«åš<code>æ¡ä»¶é˜Ÿåˆ—</code>ã€‚é‡Œé¢çš„æ¯ä¸ªèŠ‚ç‚¹çš„waitStatusä¸ºconditionã€‚æˆ‘ä»¬ä¸å¦¨å°†å‰é¢çš„é˜Ÿåˆ—ç§°ä¸º<code>åŒæ­¥é˜Ÿåˆ—</code>ï¼Œä»¥åšåŒºåˆ†ã€‚æ‰€æœ‰åœ¨åŒä¸€ä¸ªæ¡ä»¶ä¸Šç­‰å¾…çš„çº¿ç¨‹éƒ½åŒæ­¥åœ¨è¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—ä¸Šï¼Œå½“æ¡ä»¶è¾¾æˆæ—¶ï¼Œè¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—çš„ç­‰å¾…æœ€ä¹…çš„é‚£ä¸ªï¼ˆç¬¬ä¸€ä¸ªï¼‰ä¼šè¢«ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œç„¶åå°±å’Œä¹‹å‰çš„ç‹¬å æ¨¡å¼ä¸€æ ·äº†ã€‚</p>
<h3 id="32conditionobjectawait">3.2 ConditionObjectçš„awaitæ“ä½œ</h3>
<pre><code class="java language-java">public final void await() throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    Node node = addConditionWaiter();  // new ä¸€ä¸ªcondition status nodeï¼Œå¹¶åŠ å…¥â€œæ¡ä»¶é˜Ÿåˆ—â€
    int savedState = fullyRelease(node);  // é‡Šæ”¾èµ„æºï¼Œå¹¶ä¿å­˜ä¹‹å‰èµ„æºçŠ¶æ€
    int interruptMode = 0;
    while (!isOnSyncQueue(node)) { // è‡ªæ—‹ï¼šblockå½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è€…æœ‰ä¸­æ–­
        LockSupport.park(this);
        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
            break;
    }
    if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)  // å†æ¬¡ç«äº‰èµ„æº
        interruptMode = REINTERRUPT;
    if (node.nextWaiter != null) // clean up if cancelled
        unlinkCancelledWaiters();
    if (interruptMode != 0) // å¦‚æœä¹‹å‰æœ‰ä¸­æ–­ï¼Œå†æ¬¡throw
        reportInterruptAfterWait(interruptMode);
}
</code></pre>
<p>è¯¥å‡½æ•°å®ç°äº†å¯¹æŸä¸ªæ¡ä»¶çš„ç­‰å¾…ï¼ŒåŒæ—¶åœ¨ç­‰å¾…æ—¶å¦‚æœæœ‰ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œä¼šåœ¨ç»“æŸæ—¶throwå‡ºæ¥ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>1. æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦æœ‰ä¸­æ–­ï¼Œå¦‚æœæœ‰ç›´æ¥throwå‡ºæ¥ï¼›</li>
<li>2. ä¿å­˜ä¹‹å‰èµ„æºçš„åŒæ­¥çŠ¶æ€ï¼ŒåŒæ—¶é‡Šæ”¾é”ï¼ˆfullyReleaseï¼‰ï¼›</li>
<li>3. è¿›å…¥è‡ªæ—‹ï¼Œå¹¶blockå½“å‰çº¿ç¨‹ã€‚é€€å‡ºæ¡ä»¶æ˜¯ï¼šå½“å‰nodeè¢«ç§»åˆ°åŒæ­¥é˜Ÿåˆ—æˆ–è€…æ£€æµ‹åˆ°æœ‰ä¸­æ–­ï¼›</li>
<li>4. è¯•å›¾é‡æ–°è·å–é”ï¼ŒåŒæ—¶å¦‚æœä¹‹å‰æœ‰ä¸­æ–­å‘ç”Ÿè¿‡ï¼Œé‡æ–°throwï¼›</li>
</ul>
<p><strong><em>è¯´æ˜</em></strong>ï¼šè¿™é‡Œçš„â€œä¸­æ–­â€ï¼Œæ˜¯å–æ¶ˆç­‰å¾…æŸä¸ªæ¡ä»¶è¾¾æˆï¼Œä¸æ˜¯å–æ¶ˆç«äº‰èµ„æºã€‚æ‰€ä»¥ï¼Œåœ¨checkInterruptWhileWaitingä¸­ä¼šå°†è¯¥nodeçš„statusè®¾ç½®ä¸º0ï¼Œå¹¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå‚ä¸ç«äº‰ã€‚</p>
<h3 id="33conditionobjectsignal">3.3 ConditionObjectçš„signalæ“ä½œ</h3>
<pre><code class="java language-java">private void doSignal(Node first) {   // ä¼ å…¥çš„å‚æ•°æ˜¯ç¬¬ä¸€ä¸ªç­‰å¾…æ¡ä»¶çš„èŠ‚ç‚¹
    do {
        if ( (firstWaiter = first.nextWaiter) == null)
            lastWaiter = null;
        first.nextWaiter = null;
    } while (!transferForSignal(first) &amp;&amp;
             (first = firstWaiter) != null);
}
final boolean transferForSignal(Node node) {
    if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))
        return false;   // å¦‚æœè®¾ç½®å¤±è´¥ï¼Œè¯æ˜è¯¥èŠ‚ç‚¹å·²ç»å¤±æ•ˆï¼Œè¢«canceläº†ï¼Œç›´æ¥è¿”å›false

    Node p = enq(node);
    int ws = p.waitStatus;
    if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL)) // å‰ç½®èŠ‚ç‚¹cancelæˆ–è€…è®¾ç½®å¤±è´¥ï¼Œé‡æ–°å”¤é†’è¯¥çº¿ç¨‹
        LockSupport.unpark(node.thread);   // è®©å…¶è¿›å…¥è‡ªæ—‹ï¼Œå‚ä¸ç«äº‰
    return true;
}
</code></pre>
<p>signalæ“ä½œä¸»è¦æ˜¯ä¸Šé¢ä¸¤ä¸ªå‡½æ•°å®ç°ï¼šä»æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå‘åæ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½è¢«æˆåŠŸç§»åˆ°åŒæ­¥é˜Ÿåˆ—çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶æ ¹æ®æƒ…å†µå”¤é†’è¯¥èŠ‚ç‚¹ã€‚</p>
<h3 id="4">4. æ€»ç»“</h3>
<p>ã€€ã€€æœ¬æ–‡ä»æºä»£ç å®ç°çš„è§’åº¦ï¼Œåˆ†åˆ«åˆ†æäº†aqsæ¡†æ¶çš„ç‹¬å æ¨¡å¼ã€å…±äº«æ¨¡å¼ä»¥åŠæ¡ä»¶æ˜¯å¦‚ä½•å®ç°çš„ã€‚ç€é‡å¯¹å…¶â€œè·å–â€å’Œâ€œé‡Šæ”¾â€è¿›è¡Œäº†åŸç†åˆ†æã€‚å¯¹åé¢åˆ†æå„ç§åŒæ­¥å·¥å…·åšäº†åŸºç¡€æ€§çš„é“ºå«ã€‚</p>
		</div>
	</body>
</html>